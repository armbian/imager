name: Build Artifacts (No Release)

# Workflow to build and upload artifacts for internal testing
# Simplified version of build.yml without signing, updater, or release management

on:
  workflow_dispatch:
    inputs:
      build_linux:
        description: 'Build Linux (x64 + ARM64)'
        type: boolean
        default: true
      build_macos:
        description: 'Build macOS (x64 + ARM64)'
        type: boolean
        default: true
      build_windows_x64:
        description: 'Build Windows x64'
        type: boolean
        default: true
      build_windows_arm64:
        description: 'Build Windows ARM64'
        type: boolean
        default: true

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  NODE_VERSION: '20'
  TAURI_CLI_VERSION: '2.9.6'
  TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
  TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

jobs:
  build-linux:
    name: build-linux ${{ matrix.type.name }} (${{ matrix.arch.name }}/${{ matrix.type.distro_id }})
    if: ${{ inputs.build_linux }}
    strategy:
      fail-fast: false
      matrix:
        arch:
          - { name: 'amd64', runner: 'ubuntu-24.04' }
          - { name: 'arm64', runner: "ubuntu-24.04-arm" }
        type:
          # deb: build in the oldest still-supported matching container: oldstable (bookworm)
          - name: 'deb'
            distro_id: "bookworm"
            container: { image: 'debian:bookworm' }
            bundles: 'deb'
            deps: "apt"
            artifacts: "src-tauri/target/release/bundle/deb/*.deb"
          # appimage: doesn't use a container (instead, runs directly on the runner); requires sudo to install deps
          - name: 'appimage'
            distro_id: "gharunner"
            bundles: 'appimage'
            deps: "apt"
            deps_gain_root: "sudo"
            artifacts: |
              src-tauri/target/release/bundle/appimage/*.AppImage
    runs-on: ${{ matrix.arch.runner }}
    container: ${{ matrix.type.container }}
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies (apt)
        if: ${{ matrix.type.deps == 'apt' }}
        run: |
          ${{ matrix.type.deps_gain_root || '' }} apt-get update

          # Install standard dependencies for all builds
          ${{ matrix.type.deps_gain_root || '' }} apt-get install -y \
            build-essential \
            curl \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf \
            libssl-dev \
            libgtk-3-dev \
            squashfs-tools \
            xdg-utils

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          package-manager-cache: false # setup-node can't add key to cache, so we do it ourselves in below step

      # Cache npm, just like setup-node would do it with "cache: npm", but with our own key that includes arch and distro
      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-${{ matrix.arch.runner }}-${{ matrix.arch.name }}-${{ matrix.type.distro_id }}-${{ hashFiles('**/package-lock.json') }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          # ensure cache separation per host distro and tauri-cli version/branch
          key: "rust-cache-${{ matrix.arch.runner }}-${{ matrix.arch.name }}-${{ matrix.type.distro_id }}-${{ matrix.type.name == 'appimage' && 'feat-portable-appimage' || env.TAURI_CLI_VERSION }}"
          # @TODO: Cargo.lock is in gitignore, so it's not included here - it would via rust-cache Action magic, no need to specify it.

      - name: Cache cargo bin (tauri-cli) # @TODO: Swatinem/rust-cache already caches this. maybe just drop this.
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin
          key: ${{ matrix.type.name == 'appimage' && 'cargo-bin-feat-portable-appimage' || 'cargo-bin' }}-${{ matrix.arch.runner }}-${{ matrix.arch.name }}-${{ matrix.type.distro_id }}-${{ hashFiles('**/Cargo.lock') }}
          # @TODO: Cargo.lock is in gitignore, so it's not included here, albeit being specified.

      - name: Install npm dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      # NOTE: Using experimental "truly portable AppImage" format from Tauri PR #12491
      # This format bundles ALL dependencies including WebKitGTK, avoiding EGL_BAD_PARAMETER
      # errors on Fedora, Arch, and other distributions. See: https://github.com/tauri-apps/tauri/pull/12491
      # Once merged into Tauri mainline, we can revert to using TAURI_CLI_VERSION
      - name: Install Tauri CLI (AppImage - experimental portable format)
        if: ${{ matrix.type.name == 'appimage' }}
        shell: bash
        run: |
          if ! command -v cargo-tauri >/dev/null 2>&1; then
            cargo install tauri-cli --git https://github.com/tauri-apps/tauri --branch feat/truly-portable-appimage --locked
          fi

      - name: Install Tauri CLI (stable version for deb and other platforms)
        if: ${{ matrix.type.name != 'appimage' }}
        shell: bash
        run: |
          if ! command -v cargo-tauri >/dev/null 2>&1; then
            cargo install tauri-cli --version "${TAURI_CLI_VERSION}" --locked
          fi

      - name: Build Tauri app (AppImage with new portable format)
        if: ${{ matrix.type.name == 'appimage' }}
        env:
          TAURI_BUNDLER_NEW_APPIMAGE_FORMAT: "true"
        run: cargo tauri build --bundles "${{ matrix.type.bundles }}"

      - name: Build Tauri app (standard build)
        if: ${{ matrix.type.name != 'appimage' }}
        run: cargo tauri build --bundles "${{ matrix.type.bundles }}"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ matrix.arch.name }}-${{ matrix.type.name }}
          path: |
            ${{ matrix.type.artifacts }}
          retention-days: 30

  build-macos:
    name: build-macos (${{ matrix.target }})
    if: ${{ inputs.build_macos }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-apple-darwin
            arch: x64
            os: macos-15
          - target: aarch64-apple-darwin
            arch: arm64
            os: macos-latest

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Rust (add target)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          key: macos-${{ matrix.target }}

      - name: Cache cargo bin (tauri-cli)
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin
          key: cargo-bin-${{ runner.os }}-${{ runner.arch }}-stable-${{ hashFiles('**/Cargo.lock') }}

      - name: Install npm dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Install Tauri CLI (if missing)
        shell: bash
        run: |
          if ! command -v cargo-tauri >/dev/null 2>&1; then
            cargo install tauri-cli --version "${TAURI_CLI_VERSION}" --locked
          fi

      - name: Build Tauri app (per-target output dir)
        shell: bash
        run: |
          cargo tauri build --target "${{ matrix.target }}" --bundles dmg,app

      - name: Zip .app bundle(s)
        shell: bash
        env:
          CARGO_TARGET_DIR: src-tauri/target/${{ matrix.target }}
        run: |
          set -euo pipefail
          shopt -s nullglob
          for app in "$CARGO_TARGET_DIR/release/bundle/macos/"*.app; do
            base="$(basename "$app" .app)"
            ditto -c -k --sequesterRsrc --keepParent "$app" "$CARGO_TARGET_DIR/release/bundle/macos/${base}-${{ matrix.arch }}.app.zip"
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}
          path: |
            src-tauri/target/${{ matrix.target }}/release/bundle/macos/*-${{ matrix.arch }}.app.zip
            src-tauri/target/${{ matrix.target }}/release/bundle/dmg/*.dmg
          retention-days: 30

  build-windows-x64:
    name: build-windows (x86_64-pc-windows-msvc)
    if: ${{ inputs.build_windows_x64 }}
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Cache cargo bin (tauri-cli)
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin
            ~\.cargo\bin
          key: cargo-bin-${{ runner.os }}-${{ runner.arch }}-stable-${{ hashFiles('**/Cargo.lock') }}

      - name: Install npm dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Install Tauri CLI (if missing)
        shell: bash
        run: |
          if ! command -v cargo-tauri >/dev/null 2>&1; then
            cargo install tauri-cli --version "${TAURI_CLI_VERSION}" --locked
          fi

      - name: Build Tauri app
        run: cargo tauri build --target x86_64-pc-windows-msvc --bundles msi,nsis

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64
          path: |
            src-tauri/target/x86_64-pc-windows-msvc/release/bundle/msi/*.msi
            src-tauri/target/x86_64-pc-windows-msvc/release/bundle/nsis/*.exe
          retention-days: 30

  build-windows-arm64:
    name: build-windows (aarch64-pc-windows-msvc)
    if: ${{ inputs.build_windows_arm64 }}
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-pc-windows-msvc

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Cache cargo bin (tauri-cli)
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin
            ~\.cargo\bin
          key: cargo-bin-${{ runner.os }}-${{ runner.arch }}-stable-${{ hashFiles('**/Cargo.lock') }}

      - name: Install npm dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Install Tauri CLI (if missing)
        shell: bash
        run: |
          if ! command -v cargo-tauri >/dev/null 2>&1; then
            cargo install tauri-cli --version "${TAURI_CLI_VERSION}" --locked
          fi

      - name: Build Tauri app
        run: cargo tauri build --target aarch64-pc-windows-msvc --bundles msi,nsis

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-arm64
          path: |
            src-tauri/target/aarch64-pc-windows-msvc/release/bundle/msi/*.msi
            src-tauri/target/aarch64-pc-windows-msvc/release/bundle/nsis/*.exe
          retention-days: 30

  summary:
    name: Build Summary
    needs:
      - build-linux
      - build-macos
      - build-windows-x64
      - build-windows-arm64
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check build results
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Linux | ${{ needs.build-linux.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS | ${{ needs.build-macos.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows x64 | ${{ needs.build-windows-x64.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows ARM64 | ${{ needs.build-windows-arm64.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Artifacts are available for download for 30 days." >> $GITHUB_STEP_SUMMARY
