# Build and Release
#
# This workflow creates production releases with GitHub Releases.
# It calls the reusable build-reusable.yml workflow with upload_target='release'.
#
# Triggers:
# - Push to tags matching 'v*' (e.g., v1.0.0, v2.1.3)
# - Manual workflow dispatch with platform selection options

name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      build_linux:
        description: 'Build Linux (x64 + ARM64)'
        type: boolean
        default: true
      build_macos:
        description: 'Build macOS (x64 + ARM64)'
        type: boolean
        default: true
      build_windows_x64:
        description: 'Build Windows x64'
        type: boolean
        default: true
      build_windows_arm64:
        description: 'Build Windows ARM64'
        type: boolean
        default: true

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # --------------------------------------------------------------------------
  # Call the reusable build workflow with release configuration
  # --------------------------------------------------------------------------
  # This job forwards all inputs and secrets to the reusable workflow.
  # The reusable workflow handles all build logic for all platforms.
  #
  # For tag pushes: all platforms are built by default.
  # For manual dispatch: platform selection is controlled by inputs.
  # --------------------------------------------------------------------------

  call-build-release:
    name: Build Release
    uses: ./.github/workflows/build-reusable.yml
    with:
      # Upload to GitHub Releases (permanent)
      upload_target: 'release'

      # Create GitHub Release (draft, published by finalize job)
      create_release: true

      # Enable code signing for macOS (notarization)
      enable_signing: true

      # Auto-increment version for production releases
      version_strategy: 'auto'

      # Platform build flags
      # For tag pushes: always build all platforms
      # For manual dispatch: use user inputs
      build_linux_x64: ${{ github.event_name == 'push' || inputs.build_linux }}
      build_linux_arm64: ${{ github.event_name == 'push' || inputs.build_linux }}
      build_macos: ${{ github.event_name == 'push' || inputs.build_macos }}
      build_windows_x64: ${{ github.event_name == 'push' || inputs.build_windows_x64 }}
      build_windows_arm64: ${{ github.event_name == 'push' || inputs.build_windows_arm64 }}

    secrets:
      # Forward all required secrets to the reusable workflow
      TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
      TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
      APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
      APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
      APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
